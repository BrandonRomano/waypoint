---
layout: docs
page_title: Version 0.11.0 - Upgrade Guide
description: |-
  This upgrade guide describes any considerations for upgrading to Waypoint 0.11.0.
---

# Upgrading to Waypoint 0.11.0 from 0.10.x

Waypoint 0.10.x can be upgraded to Waypoint 0.11.0 using a [standard upgrade](/waypoint/docs/upgrading#standard-upgrade).
There are some considerations depending on what platform your server is installed on.
There are no breaking changes in the protocol or `waypoint.hcl` configuration file.
Due to the changes in `runner` management, we cannot guarantee that all Waypoint
components (CLI, entrypoint, and server) are forwards and backwards
compatible. We encourage users to have all components on the same version.

## Server Snapshot

Waypoint servers at versions 0.10.4 and 0.10.5 have a [bug that prevents
snapshots from being taken](https://github.com/hashicorp/waypoint/pull/4523),
if there is a dynamic configuration source set using the `waypoint config
source-set` command, like so.

If your server is running at either of these versions and a config
source is set, then you will not be able to take snapshots using the command
`server snapshot`. By default the `server upgrade` command will attempt to take
a snapshot of the database before upgrading and this will fail due to this bug.

There are a few options to upgrade to v0.11.0. If you do not need a snapshot of
the database before upgrading, then you may run `server upgrade` with the flag
`-snapshot=false` to proceed with upgrading, like so.

```shell
$ waypoint server upgrade -snapshot=false
```

Another alternative is to delete all config sources from Waypoint using
`config source-set` with the `-delete` flag, and then running `server upgrade`.
After the server is upgraded, you can re-create the config sources using
`config source-set`.

```shell
# Repeat the command below for each config source that is set; this example
# deletes the globally-scoped Vault config source
$ waypoint config source-set -delete -type=vault -scope=global
````

A third approach is to use platform-native persistence solutions to back up the
file system where the Waypoint database is stored. This includes Docker, AWS
ECS, Kubernetes, and HashiCorp Nomad. The steps to do this with each of these
platforms are detailed below.

### Docker

The Waypoint server stores data into a single `data.db` file, in Docker it's
normally stored in `/data/data.db`. In the server data directory, copy the
snapshot data and name the file `waypoint-restore.db`.

Now run `waypoint server upgrade -snapshot=false`.

### AWS ECS

The database of a Waypoint server installed to AWS ECS is persisted in a file
system, provided by the Elastic File System (EFS) service of AWS. To preserve
the database during the upgrade, a new EFS volume will need to be created. An
access point will need to be added to this volume as well. This access point's
path must be set to `/waypointserverdata`. The POSIX user and root directory
creation permissions should both have their user and group ID set to `100` and
`1000`, respectively. The access point permissions should be set to `755`.

The data in the old file system must be synchronized to the new one. This may be
done using [AWS DataSync](https://docs.aws.amazon.com/datasync/latest/userguide/what-is-datasync.html).
The source location should be configured as your old file system for the
Waypoint server and the destination should be configured as the file system you
just created.

Now run `waypoint server upgrade -snapshot=false`.

### Kubernetes

Given that volume snapshots are not part of the core API, as a pre-requisite to
taking a volume snapshot, ensure CRDs are installed first. Once complete, proceed.

Confirm your storage class and add that to the following command to create a
volume snapshot. Then verify your snapshot was created.

```shell-session
$ kubectl get storageclass

$ cat <<EOF | kubectl apply -f -
apiVersion: snapshot.storage.k8s.io/v1
kind: VolumeSnapshot
metadata:
  name: waypoint-snapshot
spec:
  volumeSnapshotClassName: <storage-class>
  source:
    persistentVolumeClaimName: data-default-waypoint-server-0
EOF

$ kubectl get volumesnapshot
NAME                READYTOUSE   SOURCEPVC                        SOURCESNAPSHOTCONTENT   RESTORESIZE   SNAPSHOTCLASS   SNAPSHOTCONTENT   CREATIONTIME   AGE
waypoint-snapshot                data-default-waypoint-server-0                                         <storage-class>                                              13s
```

Now run: `waypoint server upgrade -snapshot=false`.

### HashiCorp Nomad

Taking a snapshot of the Waypoint server's database before an upgrade will
depend on what storage Waypoint was initially setup with. For host mounted
volumes you will need to make a manual backup of the host volume itself and
attempt the upgrade with snapshots disabled.

If you previously installed Waypoint using a CSI driver, it is possible to use
the snapshot feature of the CSI driver to ensure a snapshot of your server is
taken before upgrading. Run the following steps to take a snapshot.

1. Stop Waypoint server
2. Take a snapshot of the volume Waypoint used for server installation in Nomad
3. Verify the snapshot is ready in Nomad before continuing
4. Upgrade Waypoint to 0.11.0
5. Verify Waypoint server version

```shell-session
$ nomad job stop waypoint-server
[...]
  ✓ Deployment "7a885db5" successful

    2023-02-14T15:44:44-08:00
    ID          = 7a885db5
    Job ID      = waypoint-server
    Job Version = 37
    Status      = successful
    Description = Deployment completed successfully

$ nomad volume snapshot create <volume-id> waypoint-0-11-upgrade
Snapshot ID                        Volume ID    Size    Create Time             Ready?
<volume-id>@waypoint-0-11-upgrade  <volume-id>  211MiB  2023-02-14-15:45-08:00  true

$ nomad job inspect waypoint-server > waypoint-server-0.10.json
$ # Make a copy of `waypoint-server.json` and set {"Job": "Stop": false} and the waypoint server image version to "0.11.0" in the "waypoint-server" task group.
$ # Submit the job to nomad to start again.

$ nomad job run -json waypoint-server-0.11.0.json
[...]
  ✓ Deployment "b82dc4a1" successful

    2023-02-14T15:49:12-08:00
    ID          = b82dc4a1
    Job ID      = waypoint-server
    Job Version = 38
    Status      = successful
    Description = Deployment completed successfully
```

Now run: `waypoint server upgrade -snapshot=false`.

#### Verifying the Server Version with the UI

You can verify the server version by loading the UI and looking at the footer.
You should see a version starting with `v0.11.0`. If you see an earlier version,
your platform may be using an old cached image.

#### Verifying the Server Version with the CLI

You can verify both the CLI version and server version by running:

```shell-session
$ waypoint version
CLI: v0.11.0 (-------)
Server: v0.11.0
```
